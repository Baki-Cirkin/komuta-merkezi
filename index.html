<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agent Komutanƒ± v5 (Auto)</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --primary: #3b82f6; --success: #22c55e; --warning: #f59e0b; --error: #ef4444; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 1.2rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin: 0; }
        .btn-icon { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #94a3b8; }

        /* DURUM KARTI */
        .status-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; position: relative; overflow: hidden; }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; z-index: 2; position: relative; }
        .status-val { font-weight: bold; color: var(--success); font-family: monospace; }
        
        /* CANLI DURUM √áUBUƒûU */
        .live-bar { height: 4px; width: 0%; background: var(--primary); position: absolute; bottom: 0; left: 0; transition: width 0.3s; }
        .live-status { text-align: center; font-size: 0.8rem; margin-top: 10px; font-weight: bold; color: #64748b; }
        
        /* Animasyonlu ƒ∞≈ülem I≈üƒ±ƒüƒ± */
        .processing { color: var(--warning) !important; animation: blink 1s infinite; }
        @keyframes blink { 50% { opacity: 0.5; } }

        .input-group { display: flex; flex-direction: column; gap: 10px; flex-grow: 1; }
        textarea { background: var(--card); border: 1px solid #334155; color: white; padding: 15px; border-radius: 12px; font-size: 1rem; resize: none; flex-grow: 1; outline: none; }
        textarea:focus { border-color: var(--primary); }

        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        button { border: none; padding: 15px; border-radius: 10px; font-weight: bold; color: white; cursor: pointer; transition: transform 0.1s; font-size: 0.9rem; }
        button:active { transform: scale(0.98); }
        
        .btn-gpt { background: linear-gradient(135deg, #10a37f, #0d8c6c); }
        .btn-claude { background: linear-gradient(135deg, #d97757, #b95e42); }
        .btn-deepseek { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-xiaomi { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-save { background: var(--primary); width: 100%; margin-top: 10px; }
        .btn-test { background: #64748b; width: 100%; margin-top: 10px; }
        
        #settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 12px; width: 85%; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; color: #aaa; cursor: pointer; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; box-sizing: border-box;}
    </style>
</head>
<body>

    <div class="header">
        <h1>Agent Komutanƒ±</h1>
        <button class="btn-icon" onclick="openSettings()">‚öôÔ∏è</button>
    </div>

    <div class="status-card" id="status-box">
        <div class="status-row"><span>Bakiye:</span> <span class="status-val" id="disp-balance">--</span></div>
        <div class="status-row"><span>Son Model:</span> <span class="status-val" id="disp-model">--</span></div>
        <div class="live-status" id="live-msg">Sistem Hazƒ±r</div>
        <div class="live-bar" id="progress-bar"></div>
    </div>

    <div class="input-group">
        <textarea id="prompt" placeholder="Ajan'a ne yaptƒ±rmak istiyorsun?"></textarea>
    </div>

    <div class="btn-grid">
        <button class="btn-deepseek" onclick="sendCommand('@deepseek')">üîµ DeepSeek</button>
        <button class="btn-gpt" onclick="sendCommand('@gpt5')">üß† GPT-5</button>
        <button class="btn-claude" onclick="sendCommand('@claude45')">üèõÔ∏è Claude</button>
        <button class="btn-xiaomi" onclick="sendCommand('@xiaomi')">‚ö° Xiaomi</button>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSettings()">&times;</span>
            <h3>‚öôÔ∏è Ayarlar</h3>
            <input type="text" id="gh-token" placeholder="ghp_xxxxxxxxxxxx">
            <input type="text" id="gh-owner" placeholder="Baki-Cirkin">
            <input type="text" id="gh-repo" placeholder="agent-mode">
            <input type="number" id="gh-issue" placeholder="6">
            <button class="btn-test" onclick="testConnection()">üîç BAƒûLANTIYI TEST ET</button>
            <button class="btn-save" onclick="saveSettings()">KAYDET</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            token: localStorage.getItem('agent_token'),
            owner: localStorage.getItem('agent_owner'),
            repo: localStorage.getItem('agent_repo'),
            issue: localStorage.getItem('agent_issue')
        };
        let monitorInterval = null;

        // Cache Kƒ±rƒ±cƒ±
        function getNoCacheUrl(url) { return url + "?t=" + new Date().getTime(); }

        if (!CONFIG.token) openSettings();
        else fetchStatus();

        function openSettings() {
            document.getElementById('gh-token').value = localStorage.getItem('agent_token') || '';
            document.getElementById('gh-owner').value = localStorage.getItem('agent_owner') || '';
            document.getElementById('gh-repo').value = localStorage.getItem('agent_repo') || '';
            document.getElementById('gh-issue').value = localStorage.getItem('agent_issue') || '';
            document.getElementById('settings-modal').style.display = 'flex';
        }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }

        function saveSettings() {
            const t = document.getElementById('gh-token').value.trim();
            const o = document.getElementById('gh-owner').value.trim();
            const r = document.getElementById('gh-repo').value.trim();
            const i = document.getElementById('gh-issue').value.trim();
            if(t && o && r && i) {
                localStorage.setItem('agent_token', t); localStorage.setItem('agent_owner', o);
                localStorage.setItem('agent_repo', r); localStorage.setItem('agent_issue', i);
                CONFIG.token = t; CONFIG.owner = o; CONFIG.repo = r; CONFIG.issue = i;
                closeSettings(); fetchStatus(); 
            } else alert("Eksik bilgi!");
        }

        async function testConnection() {
            const t = document.getElementById('gh-token').value.trim();
            const o = document.getElementById('gh-owner').value.trim();
            const r = document.getElementById('gh-repo').value.trim();
            if (!t) return alert("Token girin!");
            try {
                const u = await fetch("https://api.github.com/user", { headers: { 'Authorization': `token ${t}` } });
                if (u.status === 401) return alert("‚ùå Token GE√áERSƒ∞Z!");
                const rp = await fetch(`https://api.github.com/repos/${o}/${r}`, { headers: { 'Authorization': `token ${t}` } });
                if (rp.status === 404) return alert("‚ùå Repo Bulunamadƒ±!");
                alert("‚úÖ BA≈ûARILI! Kaydedin.");
            } catch (e) { alert("‚ùå Hata: " + e.message); }
        }

        async function fetchStatus() {
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/STATUS.md`;
            try {
                const res = await fetch(getNoCacheUrl(url), { headers: { 'Authorization': `token ${CONFIG.token}` } });
                if (res.ok) {
                    const data = await res.json();
                    const content = atob(data.content);
                    document.getElementById('disp-balance').innerText = content.match(/Bakiye\*\* \| `(.*)`/)?.[1] || "--";
                    document.getElementById('disp-model').innerText = content.match(/Model\*\* \| `(.*)`/)?.[1] || "--";
                }
            } catch (e) {}
        }

        async function sendCommand(agentPrefix) {
            const text = document.getElementById('prompt').value;
            if (!text) return alert("G√∂rev yok!");

            updateLiveStatus("‚è≥ Emir G√∂nderiliyor...", "blue", 10);
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues/${CONFIG.issue}/comments`;
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ body: `${agentPrefix} ${text}` })
                });

                if (res.ok) {
                    document.getElementById('prompt').value = "";
                    startMonitoring(); // ƒ∞ZLEMEYƒ∞ BA≈ûLAT
                } else {
                    updateLiveStatus("‚ùå G√∂nderim Hatasƒ±", "red", 0);
                }
            } catch (e) { updateLiveStatus("‚ùå Hata: " + e.message, "red", 0); }
        }

        // --- üïµÔ∏è‚Äç‚ôÇÔ∏è CANLI TAKƒ∞P Sƒ∞STEMƒ∞ ---
        function startMonitoring() {
            if (monitorInterval) clearInterval(monitorInterval);
            let attempts = 0;
            
            updateLiveStatus("üöÄ Ba≈ülatƒ±lƒ±yor...", "orange", 20);

            monitorInterval = setInterval(async () => {
                attempts++;
                // 30 deneme (yakla≈üƒ±k 2 dk) sonra dur
                if (attempts > 30) { clearInterval(monitorInterval); updateLiveStatus("Zaman A≈üƒ±mƒ± (Manuel Kontrol Edin)", "gray", 0); return; }

                try {
                    // GitHub Actions Workflow'larƒ±nƒ± kontrol et
                    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/actions/runs?per_page=1`;
                    const res = await fetch(getNoCacheUrl(url), { headers: { 'Authorization': `token ${CONFIG.token}` } });
                    const data = await res.json();
                    
                    if (data.workflow_runs && data.workflow_runs.length > 0) {
                        const run = data.workflow_runs[0];
                        
                        if (run.status === 'in_progress' || run.status === 'queued') {
                            updateLiveStatus(`‚öôÔ∏è Ajan √áalƒ±≈üƒ±yor... (${run.status})`, "#f59e0b", 60);
                            document.getElementById('live-msg').classList.add('processing');
                        } else if (run.status === 'completed') {
                            if (run.conclusion === 'success') {
                                clearInterval(monitorInterval);
                                updateLiveStatus("‚úÖ Tamamlandƒ±! Veriler G√ºncelleniyor...", "#22c55e", 100);
                                document.getElementById('live-msg').classList.remove('processing');
                                setTimeout(() => {
                                    fetchStatus(); // Bakiyeyi √ßek
                                    updateLiveStatus("Sistem Hazƒ±r", "#64748b", 0);
                                }, 2000);
                            } else {
                                clearInterval(monitorInterval);
                                updateLiveStatus("‚ùå Ajan Hata Aldƒ±!", "#ef4444", 100);
                                document.getElementById('live-msg').classList.remove('processing');
                            }
                        }
                    }
                } catch (e) { console.log("ƒ∞zleme hatasƒ±", e); }
            }, 4000); // 4 saniyede bir kontrol et
        }

        function updateLiveStatus(msg, color, width) {
            const msgEl = document.getElementById('live-msg');
            const barEl = document.getElementById('progress-bar');
            msgEl.innerText = msg;
            msgEl.style.color = color === "blue" ? "#3b82f6" : color;
            barEl.style.width = width + "%";
            barEl.style.backgroundColor = color;
        }
    </script>
</body>
</html>
