<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Agent KomutanÄ± (Chat)</title>
    <style>
        :root { --bg: #0f172a; --card: #1e293b; --text: #e2e8f0; --primary: #3b82f6; --success: #22c55e; --warning: #f59e0b; --error: #ef4444; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Segoe UI', sans-serif; margin: 0; padding: 20px; display: flex; flex-direction: column; height: 100vh; box-sizing: border-box; }
        
        .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
        h1 { font-size: 1.2rem; color: var(--primary); text-transform: uppercase; letter-spacing: 1px; margin: 0; }
        .btn-icon { background: none; border: none; font-size: 1.5rem; cursor: pointer; padding: 0; color: #94a3b8; }

        .status-card { background: var(--card); padding: 15px; border-radius: 12px; margin-bottom: 20px; border: 1px solid #334155; position: relative; overflow: hidden; min-height: 80px; }
        .status-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; z-index: 2; position: relative; }
        .status-val { font-weight: bold; color: var(--success); font-family: monospace; }
        
        .live-container { display: flex; align-items: center; justify-content: center; margin-top: 15px; gap: 10px; }
        .live-status { font-size: 0.9rem; font-weight: bold; color: #64748b; }
        
        .spinner { border: 3px solid rgba(255, 255, 255, 0.1); border-left-color: var(--primary); border-radius: 50%; width: 20px; height: 20px; animation: spin 1s linear infinite; display: none; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* YENÄ°: CEVAP KUTUSU */
        #response-box {
            background: #000; color: #0f0; font-family: 'Courier New', monospace;
            padding: 15px; border-radius: 8px; border: 1px solid #333; margin-bottom: 15px;
            font-size: 0.9rem; min-height: 50px; white-space: pre-wrap; display: none;
        }

        .input-group { display: flex; flex-direction: column; gap: 10px; flex-grow: 1; margin-bottom: 10px; }
        textarea { background: var(--card); border: 1px solid #334155; color: white; padding: 15px; border-radius: 12px; font-size: 1rem; resize: none; flex-grow: 1; outline: none; }
        textarea:focus { border-color: var(--primary); }

        .model-container { overflow-y: auto; max-height: 250px; padding-right: 5px; }
        .btn-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        button { border: none; padding: 12px; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 0.85rem; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;}
        button:active { transform: scale(0.98); }
        
        .btn-gpt { background: linear-gradient(135deg, #10a37f, #0d8c6c); }
        .btn-claude { background: linear-gradient(135deg, #d97757, #b95e42); }
        .btn-gemini { background: linear-gradient(135deg, #4285f4, #34a853); }
        .btn-deepseek { background: linear-gradient(135deg, #3b82f6, #2563eb); }
        .btn-qwen { background: linear-gradient(135deg, #8b5cf6, #7c3aed); }
        .btn-free { background: linear-gradient(135deg, #f59e0b, #d97706); }
        .btn-other { background: linear-gradient(135deg, #ec4899, #db2777); }
        
        .btn-save { background: var(--primary); width: 100%; margin-top: 10px; }
        .btn-test { background: #64748b; width: 100%; margin-top: 10px; }
        #settings-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: none; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background: var(--card); padding: 20px; border-radius: 12px; width: 85%; position: relative; }
        .close-modal { position: absolute; top: 10px; right: 15px; font-size: 1.5rem; color: #aaa; cursor: pointer; }
        input { width: 100%; padding: 10px; margin: 10px 0; background: #0f172a; border: 1px solid #334155; color: white; border-radius: 8px; box-sizing: border-box;}
    </style>
</head>
<body>

    <div class="header">
        <h1>Komuta Merkezi</h1>
        <button class="btn-icon" onclick="openSettings()">âš™ï¸</button>
    </div>

    <div class="status-card" id="status-box">
        <div class="status-row"><span>Bakiye:</span> <span class="status-val" id="disp-balance">--</span></div>
        <div class="status-row"><span>Son Model:</span> <span class="status-val" id="disp-model">--</span></div>
        <div class="live-container">
            <div class="spinner" id="loading-spinner"></div>
            <div class="live-status" id="live-msg">Sistem HazÄ±r</div>
        </div>
    </div>

    <div id="response-box"></div>

    <div class="input-group">
        <textarea id="prompt" placeholder="Soru sor veya gÃ¶rev ver..."></textarea>
    </div>

    <div class="model-container">
        <div class="btn-grid">
            <button class="btn-gpt" onclick="sendCommand('@gpt5')">ğŸ§  GPT-5.2 Chat</button>
            <button class="btn-claude" onclick="sendCommand('@claude45')">ğŸ›ï¸ Claude 4.5 Sonnet</button>
            <button class="btn-claude" style="background:#7c3aed" onclick="sendCommand('@opus45')">ğŸ­ Claude 4.5 Opus</button>
            <button class="btn-gemini" onclick="sendCommand('@gemini3')">ğŸ’ Gemini 3 Pro</button>
            <button class="btn-deepseek" onclick="sendCommand('@deepseek3')">ğŸ”µ DeepSeek 3.2 Sp.</button>
            <button class="btn-qwen" onclick="sendCommand('@qwen3')">ğŸ‰ Qwen 3 Max</button>
            <button class="btn-other" onclick="sendCommand('@glm4')">âš¡ GLM 4.7</button>
            <button class="btn-other" style="background:#06b6d4" onclick="sendCommand('@minimax')">ğŸ¦„ Minimax M2.1</button>
            <button class="btn-other" style="background:#be185d" onclick="sendCommand('@moonshot')">ğŸŒ™ Moonshot K2</button>
            <button class="btn-free" onclick="sendCommand('@xiaomi')">ğŸ†“ Xiaomi (Bedava)</button>
            <button class="btn-free" style="background:#ea580c" onclick="sendCommand('@hermes')">ğŸ†“ Hermes 3 (Bedava)</button>
            <button class="btn-free" style="background:#65a30d" onclick="sendCommand('@devstral')">ğŸ†“ Devstral (Bedava)</button>
        </div>
    </div>

    <div id="settings-modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSettings()">&times;</span>
            <h3>âš™ï¸ Ayarlar</h3>
            <input type="text" id="gh-token" placeholder="ghp_xxxxxxxxxxxx">
            <input type="text" id="gh-owner" placeholder="Baki-Cirkin">
            <input type="text" id="gh-repo" placeholder="agent-mode">
            <input type="number" id="gh-issue" placeholder="6">
            <button class="btn-test" onclick="testConnection()">ğŸ” BAÄLANTIYI TEST ET</button>
            <button class="btn-save" onclick="saveSettings()">KAYDET</button>
        </div>
    </div>

    <script>
        const CONFIG = {
            token: localStorage.getItem('agent_token'),
            owner: localStorage.getItem('agent_owner'),
            repo: localStorage.getItem('agent_repo'),
            issue: localStorage.getItem('agent_issue')
        };
        let monitorInterval = null;

        function getNoCacheUrl(url) { return url + "?t=" + new Date().getTime(); }
        if (!CONFIG.token) openSettings();
        else fetchStatus();

        function openSettings() {
            document.getElementById('gh-token').value = localStorage.getItem('agent_token') || '';
            document.getElementById('gh-owner').value = localStorage.getItem('agent_owner') || '';
            document.getElementById('gh-repo').value = localStorage.getItem('agent_repo') || '';
            document.getElementById('gh-issue').value = localStorage.getItem('agent_issue') || '';
            document.getElementById('settings-modal').style.display = 'flex';
        }
        function closeSettings() { document.getElementById('settings-modal').style.display = 'none'; }
        function saveSettings() {
            const t = document.getElementById('gh-token').value.trim();
            const o = document.getElementById('gh-owner').value.trim();
            const r = document.getElementById('gh-repo').value.trim();
            const i = document.getElementById('gh-issue').value.trim();
            if(t && o && r && i) {
                localStorage.setItem('agent_token', t); localStorage.setItem('agent_owner', o);
                localStorage.setItem('agent_repo', r); localStorage.setItem('agent_issue', i);
                CONFIG.token = t; CONFIG.owner = o; CONFIG.repo = r; CONFIG.issue = i;
                closeSettings(); fetchStatus(); 
            } else alert("Eksik bilgi!");
        }

        async function testConnection() {
            const t = document.getElementById('gh-token').value.trim();
            const o = document.getElementById('gh-owner').value.trim();
            const r = document.getElementById('gh-repo').value.trim();
            if (!t) return alert("Token girin!");
            try {
                const u = await fetch("https://api.github.com/user", { headers: { 'Authorization': `token ${t}` } });
                if (u.status === 401) return alert("âŒ Token GEÃ‡ERSÄ°Z!");
                const rp = await fetch(`https://api.github.com/repos/${o}/${r}`, { headers: { 'Authorization': `token ${t}` } });
                if (rp.status === 404) return alert("âŒ Repo BulunamadÄ±!");
                alert("âœ… BAÅARILI!");
            } catch (e) { alert("âŒ Hata: " + e.message); }
        }

        async function fetchStatus() {
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/STATUS.md`;
            try {
                const res = await fetch(getNoCacheUrl(url), { headers: { 'Authorization': `token ${CONFIG.token}` } });
                if (res.ok) {
                    const data = await res.json();
                    const content = atob(data.content);
                    document.getElementById('disp-balance').innerText = content.match(/Bakiye\*\* \| `(.*)`/)?.[1] || "--";
                    document.getElementById('disp-model').innerText = content.match(/Model\*\* \| `(.*)`/)?.[1] || "--";
                }
            } catch (e) {}
        }

        // --- YENÄ°: CEVABI OKUMA FONKSÄ°YONU ---
        async function fetchReply() {
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/LAST_REPLY.txt`;
            try {
                const res = await fetch(getNoCacheUrl(url), { headers: { 'Authorization': `token ${CONFIG.token}` } });
                if (res.ok) {
                    const data = await res.json();
                    // Unicode karakterleri dÃ¼zgÃ¼n Ã§Ã¶zmek iÃ§in decodeURIComponent + escape
                    const content = decodeURIComponent(escape(atob(data.content)));
                    const box = document.getElementById('response-box');
                    box.style.display = 'block';
                    box.innerText = "ğŸ¤– " + content;
                }
            } catch (e) {}
        }

        async function getLastRunId() {
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/actions/runs?per_page=1`;
            try {
                const res = await fetch(getNoCacheUrl(url), { headers: { 'Authorization': `token ${CONFIG.token}` } });
                const data = await res.json();
                return (data.workflow_runs && data.workflow_runs.length > 0) ? data.workflow_runs[0].id : 0;
            } catch (e) { return 0; }
        }

        async function sendCommand(agentPrefix) {
            const text = document.getElementById('prompt').value;
            if (!text) return alert("GÃ¶rev yok!");
            setLiveState("loading", "â³ Ä°letiliyor...");
            document.getElementById('response-box').style.display = 'none'; // Yeni emirde eski cevabÄ± gizle
            
            const lastRunId = await getLastRunId();
            const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/issues/${CONFIG.issue}/comments`;
            
            try {
                const res = await fetch(url, {
                    method: 'POST',
                    headers: { 'Authorization': `token ${CONFIG.token}`, 'Content-Type': 'application/json' },
                    body: JSON.stringify({ body: `${agentPrefix} ${text}` })
                });
                if (res.ok) {
                    document.getElementById('prompt').value = "";
                    setLiveState("loading", "â³ Ajan Bekleniyor...");
                    startMonitoring(lastRunId);
                } else { setLiveState("error", "âŒ GÃ¶nderim HatasÄ±"); }
            } catch (e) { setLiveState("error", "âŒ Hata: " + e.message); }
        }

        function startMonitoring(oldRunId) {
            if (monitorInterval) clearInterval(monitorInterval);
            let attempts = 0;
            monitorInterval = setInterval(async () => {
                attempts++;
                if (attempts > 60) { clearInterval(monitorInterval); setLiveState("idle", "Zaman AÅŸÄ±mÄ±"); return; }
                try {
                    const url = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/actions/runs?per_page=1`;
                    const res = await fetch(getNoCacheUrl(url), { headers: { 'Authorization': `token ${CONFIG.token}` } });
                    const data = await res.json();
                    if (data.workflow_runs && data.workflow_runs.length > 0) {
                        const run = data.workflow_runs[0];
                        if (run.id > oldRunId) {
                            if (run.status === 'in_progress' || run.status === 'queued') setLiveState("loading", `âš™ï¸ Ä°ÅŸleniyor...`);
                            else if (run.status === 'completed') {
                                clearInterval(monitorInterval);
                                if (run.conclusion === 'success') {
                                    setLiveState("success", "âœ… TamamlandÄ±!");
                                    // HEMEN CEVABI Ã‡EK!
                                    setTimeout(() => { 
                                        fetchReply(); 
                                        fetchStatus(); 
                                        setLiveState("idle", "Sistem HazÄ±r"); 
                                    }, 2000);
                                } else setLiveState("error", "âŒ Hata AldÄ±!");
                            }
                        }
                    }
                } catch (e) {}
            }, 4000);
        }

        function setLiveState(state, msg) {
            const msgEl = document.getElementById('live-msg');
            const spinner = document.getElementById('loading-spinner');
            msgEl.innerText = msg;
            if (state === "loading") { spinner.style.display = "block"; msgEl.style.color = "#3b82f6"; }
            else if (state === "success") { spinner.style.display = "none"; msgEl.style.color = "#22c55e"; }
            else if (state === "error") { spinner.style.display = "none"; msgEl.style.color = "#ef4444"; }
            else { spinner.style.display = "none"; msgEl.style.color = "#64748b"; }
        }
    </script>
</body>
</html>
